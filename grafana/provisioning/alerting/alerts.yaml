apiVersion: 1

# Grafana unified alerting provisioning
# These rule groups map to the threat model detection points.
# NOTE: Adjust evaluation intervals & for durations based on real workload once baseline is observed.

# Datasource references use UIDs set in datasources provisioning.

groups:
  - orgId: 1
    name: tatou-core-health
    folder: Tatou Alerts
    interval: 1m
    rules:
      - uid: tatou_api_latency_p95
        title: High API latency (p95)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                histogram_quantile(0.95, sum by (le) (rate(tatou_http_request_duration_seconds_bucket[5m])))
              instant: true
              interval: ""
              legendFormat: p95
              range: false
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                0.5
              instant: true
              range: false
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: $A>=$B
              interval: 1m
              refId: C
              type: math
        for: 5m
        annotations:
          summary: 95th percentile request latency above threshold
        labels:
          severity: warning
      - uid: tatou_api_errors_spike
        title: HTTP error rate spike
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                sum(increase(tatou_http_requests_total{status=~"5.."}[5m]))
                  / clamp_min(sum(increase(tatou_http_requests_total[5m])),1) > 0.05
              instant: true
              range: false
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 5m
        annotations:
          summary: 5xx responses exceed 5% of total in last 5m
        labels:
          severity: warning
      - uid: tatou_login_bruteforce
        title: Brute force login suspected
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                increase(tatou_login_failures_total[5m]) > 50
              instant: true
              range: false
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 1m
        annotations:
          summary: >-
            More than 50 failed logins in 5m window (possible brute force)
        labels:
          severity: high
      - uid: tatou_watermark_fail_ratio
        title: Watermark failure ratio elevated
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                (sum(increase(tatou_watermarks_failed_total[15m]))
                 / clamp_min(sum(increase(tatou_watermarks_created_total[15m])),1)) > 0.05
              instant: true
              range: false
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 10m
        annotations:
          summary: >-
            Watermark failure ratio >5% over 15m (fuzzing or regression)
        labels:
          severity: warning
      - uid: tatou_version_404_guessing
        title: Possible version link guessing
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                sum(increase(tatou_http_requests_total{route="/api/get-version/<link>",status="404"}[1h])) > 200
              instant: true
              range: false
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 0m
        annotations:
          summary: >-
            More than 200 404 responses for get-version in 1h (secret guessing)
        labels:
          severity: info
      - uid: tatou_upload_volume_spike
        title: Upload volume spike
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                increase(tatou_upload_bytes_total[10m]) > 2 * (increase(tatou_upload_bytes_total[20m]) / 2)
              instant: true
              range: false
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 5m
        annotations:
          summary: Upload bytes 10m window >2x prior 10m baseline
        labels:
          severity: warning
      - uid: tatou_db_error_spike
        title: DB error spike
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                increase(tatou_db_errors_total[5m]) > 5
              instant: true
              range: false
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 2m
        annotations:
          summary: >-
            More than 5 DB errors in 5m (potential SQLi attempts or backend issue)
        labels:
          severity: warning
      - uid: tatou_suspicious_event_rate
        title: Suspicious validation events elevated
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                increase(tatou_suspicious_events_total[5m]) > 20
              instant: true
              range: false
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 2m
        annotations:
          summary: >-
            Over 20 suspicious validation events in 5m (probing / fuzzing)
        labels:
          severity: info
      - uid: tatou_watermark_read_to_create_ratio
        title: Watermark read/create ratio anomalous
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: |
                (sum(increase(tatou_watermarks_read_total[30m]))
                  / clamp_min(sum(increase(tatou_watermarks_created_total[30m])),1)) > 10
              instant: true
              range: false
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 10m
        annotations:
          summary: >-
            Watermark read/create ratio >10 in 30m (enumeration attempt?)
        labels:
          severity: info
  - orgId: 1
    name: tatou-logs-runtime
    folder: Tatou Alerts
    interval: 2m
    rules:
      - uid: tatou_falco_high_priority
        title: Falco high priority alert
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P982945308D3682D1
            model:
              editorMode: builder
              expr: |
                sum(count_over_time({container="/falco"} |= "Critical" [10m])) > 0
              queryType: range
              maxLines: 0
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 0m
        annotations:
          summary: Falco reported a critical priority event
        labels:
          severity: critical
      - uid: tatou_shell_detection
        title: Possible shell in container
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P982945308D3682D1
            model:
              editorMode: code
              expr: |
                sum(count_over_time({container="/falco"} |= "shell was spawned" [10m])) > 0
              queryType: range
              maxLines: 0
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                  - evaluator:
                      params:
                          - 0
                          - 0
                      type: gt
                    operator:
                      type: and
                    query:
                      params: []
                    reducer:
                      params: []
                      type: avg
                    type: query
              datasource:
                  name: Expression
                  type: __expr__
                  uid: __expr__
              expression: A
              hide: false
              reducer: last
              refId: B
              type: reduce
        for: 0m
        annotations:
          summary: Falco log indicates shell spawned inside container
        labels:
          severity: high
